# SkyReels-V2 æ¨¡å‹æ¶æ„è§£æ

## ğŸ—ï¸ æ•´ä½“æ¶æ„æ¦‚è§ˆ

SkyReels-V2é‡‡ç”¨**å¤šç»„ä»¶ååŒæ¶æ„**ï¼ŒåŒ…å«4ä¸ªæ ¸å¿ƒæ¨¡å—ï¼š

```
SkyReels-V2 æ¶æ„
â”œâ”€â”€ ğŸ§  WanModel (æ ¸å¿ƒTransformer) - 14B/1.3Bå‚æ•°
â”œâ”€â”€ ğŸ¬ WanVAE (3Dè§†é¢‘ç¼–è§£ç å™¨) 
â”œâ”€â”€ ğŸ“ T5TextEncoder (æ–‡æœ¬ç†è§£)
â””â”€â”€ ğŸ‘ï¸ CLIP (è§†è§‰ç†è§£ï¼ŒI2Væ¨¡å¼)
```

## ğŸ§  æ ¸å¿ƒç»„ä»¶1: WanModel (Transformerä¸»å¹²)

è¿™æ˜¯SkyReels-V2çš„**å¤§è„‘**ï¼Œè´Ÿè´£å®é™…çš„è§†é¢‘ç”Ÿæˆï¼š

```python
class WanModel:
    def __init__(self):
        # æ¶æ„å‚æ•° (14Bæ¨¡å‹é…ç½®)
        self.dim = 2048          # éšè—ç»´åº¦  
        self.ffn_dim = 8192      # FFNä¸­é—´å±‚ç»´åº¦
        self.num_heads = 16      # æ³¨æ„åŠ›å¤´æ•°
        self.num_layers = 32     # Transformerå±‚æ•°
        self.in_dim = 16         # è¾“å…¥é€šé“ (VAEæ½œåœ¨ç©ºé—´)
        self.out_dim = 16        # è¾“å‡ºé€šé“
        self.patch_size = (1,2,2) # 3Dåˆ†å—å¤§å° (æ—¶é—´,é«˜,å®½)
        
        # å…³é”®ç»„ä»¶
        self.patch_embedding    # 3Då·ç§¯ï¼šè§†é¢‘â†’Tokenåºåˆ—
        self.text_embedding     # æ–‡æœ¬ç‰¹å¾æŠ•å½±
        self.time_embedding     # æ—¶é—´æ­¥åµŒå…¥
        self.blocks            # 32ä¸ªTransformer Block
        self.head              # è¾“å‡ºå¤´
```

**æ ¸å¿ƒåˆ›æ–°ç‚¹ï¼š**
- **3D Patch Embedding**: å°†è§†é¢‘åˆ†å—ä¸ºæ—¶ç©ºtoken
- **RoPEä½ç½®ç¼–ç **: 3ç»´æ—‹è½¬ä½ç½®ç¼–ç (æ—¶é—´+ç©ºé—´)  
- **æ··åˆæ³¨æ„åŠ›**: è‡ªæ³¨æ„åŠ›+æ–‡æœ¬äº¤å‰æ³¨æ„åŠ›
- **å› æœæ©ç **: æ”¯æŒDiffusion Forcingçš„çµæ´»æ©ç 

## ğŸ¬ æ ¸å¿ƒç»„ä»¶2: WanVAE (3Dè§†é¢‘VAE)

è´Ÿè´£**è§†é¢‘â†”æ½œåœ¨ç©ºé—´**çš„è½¬æ¢ï¼š

```python
class WanVAE:
    def __init__(self):
        # ç¼–ç å™¨ç»“æ„
        self.encoder = Encoder3d(
            dim_mult=[1, 2, 4, 4],        # é€šé“å€å¢åºåˆ—
            temperal_downsample=[T,T,F],  # æ—¶é—´ä¸‹é‡‡æ ·æ¨¡å¼
            num_res_blocks=2              # æ®‹å·®å—æ•°é‡
        )
        
        # è§£ç å™¨ç»“æ„  
        self.decoder = Decoder3d(...)
        
    # å‹ç¼©ç‡è®¾è®¡
    # è¾“å…¥: [B, 3, T, H, W]
    # è¾“å‡º: [B, 16, T/4, H/8, W/8]  â† æ—¶é—´4å€,ç©ºé—´64å€å‹ç¼©
```

**è®¾è®¡ç‰¹ç‚¹ï¼š**
- **3Då› æœå·ç§¯**: ä¿æŒæ—¶é—´å› æœæ€§  
- **æ¸è¿›ä¸‹é‡‡æ ·**: æ—¶é—´4å€ã€ç©ºé—´64å€å‹ç¼©
- **åˆ†å—å¤„ç†**: 1+4+4+4...å¸§æ–¹å¼å¤„ç†ï¼ŒèŠ‚çœæ˜¾å­˜

## ğŸ“ æ ¸å¿ƒç»„ä»¶3: T5æ–‡æœ¬ç¼–ç å™¨

```python 
class T5TextEncoder:
    # åŸºäºT5-XXLæ¨¡å‹
    # æ–‡æœ¬é•¿åº¦: 512 tokens
    # è¾“å‡ºç»´åº¦: 4096 â†’ 2048 (æŠ•å½±åˆ°Transformerç»´åº¦)
```

## ğŸ‘ï¸ æ ¸å¿ƒç»„ä»¶4: CLIPè§†è§‰ç¼–ç å™¨ (I2Vä¸“ç”¨)

```python
class XLMRobertaCLIP:
    def __init__(self):
        self.vision_layers = 32      # è§†è§‰Transformerå±‚æ•°
        self.vision_dim = 1280       # è§†è§‰ç‰¹å¾ç»´åº¦
        self.text_layers = 24        # æ–‡æœ¬å±‚æ•°
        # è¾“å‡º: 1280ç»´å›¾åƒç‰¹å¾ â†’ 2048ç»´æŠ•å½±
```

## ğŸ”§ æ¶æ„è®¾è®¡äº®ç‚¹

### 1. å¤šå°ºåº¦æ³¨æ„åŠ›æœºåˆ¶

```python
class WanAttentionBlock:
    def __init__(self):
        # è‡ªæ³¨æ„åŠ›: å¤„ç†æ—¶ç©ºä¾èµ–  
        self.self_attn = FlashAttention(
            dim=2048, 
            num_heads=16,
            qk_norm=True  # Query/Keyå½’ä¸€åŒ–
        )
        
        # äº¤å‰æ³¨æ„åŠ›: æ–‡æœ¬æ¡ä»¶å¼•å¯¼
        self.cross_attn = CrossAttention(
            query_dim=2048,
            cross_dim=4096,  # T5æ–‡æœ¬ç‰¹å¾
            heads=16
        )
        
        # FFN: Swishæ¿€æ´»çš„å‰é¦ˆç½‘ç»œ
        self.ffn = FeedForward(2048, 8192)
```

### 2. 3D RoPEä½ç½®ç¼–ç 

```python
def rope_apply(x, grid_sizes, freqs):
    f, h, w = grid_sizes  # æ—¶é—´,é«˜,å®½ç»´åº¦
    
    # åˆ†åˆ«ä¸º3ä¸ªç»´åº¦è®¡ç®—æ—‹è½¬é¢‘ç‡
    freqs_t = freqs[0][:f]  # æ—¶é—´ç»´åº¦
    freqs_h = freqs[1][:h]  # é«˜åº¦ç»´åº¦  
    freqs_w = freqs[2][:w]  # å®½åº¦ç»´åº¦
    
    # ç»„åˆ3Dä½ç½®ç¼–ç 
    freqs_3d = torch.cat([freqs_t, freqs_h, freqs_w], dim=-1)
    return x * freqs_3d  # åº”ç”¨æ—‹è½¬å˜æ¢
```

### 3. æ¨¡å¼è‡ªé€‚åº”è®¾è®¡

```python
# T2Væ¨¡å¼: çº¯æ–‡æœ¬æ¡ä»¶
if model_type == "t2v":
    cross_attn_type = "t2v_cross_attn"  # åªæœ‰æ–‡æœ¬äº¤å‰æ³¨æ„åŠ›
    
# I2Væ¨¡å¼: æ–‡æœ¬+å›¾åƒæ¡ä»¶  
elif model_type == "i2v":
    cross_attn_type = "i2v_cross_attn"  # æ–‡æœ¬+å›¾åƒäº¤å‰æ³¨æ„åŠ›
    self.img_emb = MLPProj(1280, 2048)  # CLIPå›¾åƒæŠ•å½±
```

## ğŸ“ˆ å‚æ•°è§„æ¨¡å¯¹æ¯”

| æ¨¡å‹ç‰ˆæœ¬ | Transformerå‚æ•° | VAEå‚æ•° | æ€»å‚æ•° | æ˜¾å­˜éœ€æ±‚ |
|---------|---------------|---------|--------|----------|
| **1.3B** | ~1.3B | ~100M | ~1.4B | ~14.7GB |
| **14B** | ~14B | ~100M | ~14.1B | ~51GB |

## ğŸ”„ å‰å‘ä¼ æ’­æµç¨‹

```python
def forward(self, x, t, context, fps=None):
    # 1. 3D Patch Embedding  
    x = self.patch_embedding(x)  # [B,16,T,H,W] â†’ [B,seq_len,2048]
    
    # 2. æ—¶é—´åµŒå…¥
    t_emb = self.time_embedding(sinusoidal_embedding(t))
    
    # 3. æ¡ä»¶åµŒå…¥
    context = self.text_embedding(context)  # T5æ–‡æœ¬ç‰¹å¾
    
    # 4. 32å±‚Transformerå¤„ç†
    for block in self.blocks:
        x = block(
            x,                    # è§†é¢‘ç‰¹å¾
            context=context,      # æ–‡æœ¬æ¡ä»¶  
            timestep_emb=t_emb,   # æ—¶é—´ä¿¡æ¯
            clip_fea=clip_fea     # å›¾åƒæ¡ä»¶(I2V)
        )
    
    # 5. è¾“å‡ºæŠ•å½±
    x = self.head(x, t_emb)  # é¢„æµ‹å™ªå£°
    return self.unpatchify(x, grid_sizes)  # é‡æ„ä¸º3D
```

## ğŸ’¡ Diffusion Forcing æ ¸å¿ƒåˆ›æ–°

**ä¼ ç»Ÿæ‰©æ•£ vs Diffusion Forcing**

```python
# ä¼ ç»Ÿæ‰©æ•£ï¼šæ‰€æœ‰å¸§å…±äº«ç›¸åŒå™ªå£°çº§åˆ«
# t: [999, 999, 999, 999, ...]  â† åŒæ­¥æ‰©æ•£

# Diffusion Forcingï¼šæ¯ä¸ªå¸§ç‹¬ç«‹å™ªå£°çº§åˆ«  
# t: [999, 800, 600, 400, 200, 0, ...]  â† å¼‚æ­¥æ‰©æ•£
```

**æ ¸å¿ƒç®—æ³•é€»è¾‘ï¼š**
```python
def generate_timestep_matrix(self, num_frames, step_template, ar_step=5):
    # ä¸ºæ¯å¸§åˆ†é…ç‹¬ç«‹æ—¶é—´æ­¥
    while not_all_frames_denoised:
        new_row = torch.zeros(num_frames_block)
        for i in range(num_frames_block):
            if i == 0 or prev_frame_completed:
                new_row[i] = prev_row[i] + 1  # å‰è¿›ä¸€æ­¥
            else:
                new_row[i] = new_row[i-1] - ar_step  # è‡ªå›å½’å»¶è¿Ÿ
        # æ›´æ–°æ©ç ï¼Œåªæ›´æ–°éœ€è¦çš„å¸§
        update_mask = (new_row != prev_row) & (new_row != completed)
```

**å…³é”®åŸç†ï¼š**
- ğŸ¯ **éƒ¨åˆ†æ©ç æœºåˆ¶**: å™ªå£°=0ä¸ºå®Œå…¨æœªæ©ç ï¼Œå®Œå…¨å™ªå£°=å®Œå…¨æ©ç 
- ğŸ”„ **æ¡ä»¶å¼•å¯¼**: ä½¿ç”¨å·²å»å™ªçš„å¸§æŒ‡å¯¼æœªå»å™ªå¸§çš„æ¢å¤
- âš¡ **æ— é™æ‰©å±•**: åŸºäºæœ€åå‡ å¸§è‡ªå›å½’ç”Ÿæˆæ–°æ®µè½

## ğŸš€ é•¿è§†é¢‘ç”Ÿæˆæœºåˆ¶

å½“éœ€è¦ç”Ÿæˆè¶…é•¿è§†é¢‘æ—¶ï¼Œä½¿ç”¨ç‰¹æ®Šçš„åˆ†æ®µç­–ç•¥ï¼š

```
é•¿è§†é¢‘ç”Ÿæˆ (30ç§’/737å¸§)
â”œâ”€â”€ ç¬¬1æ®µ: ç”Ÿæˆ1-97å¸§
â”œâ”€â”€ ç¬¬2æ®µ: ç”¨80-97å¸§ä½œä¸ºæ¡ä»¶ï¼Œç”Ÿæˆ98-177å¸§  
â”œâ”€â”€ ç¬¬3æ®µ: ç”¨160-177å¸§ä½œä¸ºæ¡ä»¶ï¼Œç”Ÿæˆ178-257å¸§
â”œâ”€â”€ ...
â””â”€â”€ ç¬¬6æ®µ: ç”Ÿæˆæœ€å80å¸§ï¼Œæ€»è®¡737å¸§

æ¯æ®µå†…éƒ¨ä½¿ç”¨Diffusion Forcing:
â”œâ”€â”€ å¸§1: æ—¶é—´æ­¥999 (æœ€å¤šå™ªå£°)
â”œâ”€â”€ å¸§2: æ—¶é—´æ­¥800  
â”œâ”€â”€ å¸§3: æ—¶é—´æ­¥600
â”œâ”€â”€ ...
â””â”€â”€ å¸§97: æ—¶é—´æ­¥0 (æ— å™ªå£°)
```

**åˆ†æ®µæ»‘çª—ç”Ÿæˆç­–ç•¥ï¼š**

```python
def long_video_generation(self, base_frames=97, total_frames=737, overlap=17):
    # è®¡ç®—è¿­ä»£æ¬¡æ•°
    n_iter = 1 + (total_frames - base_frames) // (base_frames - overlap) 
    # ä¾‹: 737å¸§ = 6æ¬¡è¿­ä»£ï¼Œæ¯æ¬¡é‡å 17å¸§
    
    output_video = None
    for i in range(n_iter):
        if output_video is not None:
            # æå–é‡å åŒºåŸŸä½œä¸ºæ¡ä»¶
            prefix_video = output_video[:, -overlap:] 
            prefix_latent = self.vae.encode(prefix_video)  # ç¼–ç ä¸ºæ½œåœ¨
            
        # å½“å‰æ®µè½ç”Ÿæˆ 
        current_segment = self.diffusion_forcing_step(
            prompt=prompt,
            prefix=prefix_latent,  # æ¡ä»¶å¸§
            num_frames=base_frames,
            ar_step=5  # è‡ªå›å½’æ­¥æ•°
        )
        
        # æ‹¼æ¥ç»“æœ(å»é™¤é‡å )
        if output_video is None:
            output_video = current_segment
        else:
            output_video = torch.cat([
                output_video, 
                current_segment[:, overlap:]  # è·³è¿‡é‡å éƒ¨åˆ†
            ], dim=1)
    
    return output_video  # æœ€ç»ˆé•¿è§†é¢‘
```

## ğŸ¯ å…³é”®æŠ€æœ¯ç‰¹æ€§

1. **ğŸ”€ æ··åˆç²¾åº¦è®­ç»ƒ**: BF16ä¸»ä½“ + FP32 VAE
2. **âš¡ Flash Attention**: é«˜æ•ˆé•¿åºåˆ—æ³¨æ„åŠ›è®¡ç®—  
3. **ğŸ§® Gradient Checkpointing**: èŠ‚çœæ˜¾å­˜çš„åå‘ä¼ æ’­
4. **ğŸ”§ åŠ¨æ€ç¼–è¯‘**: PyTorch 2.0 compileåŠ é€Ÿ
5. **ğŸ­ çµæ´»æ©ç **: æ”¯æŒåŒæ­¥/å¼‚æ­¥Diffusion Forcing
6. **ğŸ’¾ TeaCache**: ç¼“å­˜ä¸­é—´ç‰¹å¾ï¼Œ3xæ¨ç†åŠ é€Ÿ
7. **ğŸš€ xDiT USP**: å¤šGPUåºåˆ—å¹¶è¡Œï¼Œçº¿æ€§æ‰©å±•
8. **ğŸ›ï¸ Memory Offload**: CPU/GPUæ˜¾å­˜åè°ƒç®¡ç†

## ğŸ“Š æ€§èƒ½ä¼˜åŠ¿

### è®¡ç®—æ•ˆç‡ä¼˜åŒ–
- **TeaCache**: ç¼“å­˜ä¸­é—´ç‰¹å¾ï¼Œ3xæ¨ç†åŠ é€Ÿ
- **xDiT USP**: å¤šGPUåºåˆ—å¹¶è¡Œï¼Œçº¿æ€§æ‰©å±•
- **Memory Offload**: CPU/GPUæ˜¾å­˜åè°ƒç®¡ç†

### è´¨é‡æ§åˆ¶æœºåˆ¶
- **SkyCaptioner-V1**: ä¸“ä¸šç”µå½±è¯­æ³•æ ‡æ³¨
- **åˆ†å±‚æ³¨æ„åŠ›**: æ—¶é—´+ç©ºé—´åˆ†ç¦»å»ºæ¨¡  
- **å¤šå°ºåº¦è®­ç»ƒ**: 540Pâ†’720Pæ¸è¿›æå‡

### æ¡ä»¶æ§åˆ¶ç²¾åº¦
- **æ–‡æœ¬å¼•å¯¼**: T5ç¼–ç å™¨æ·±åº¦ç†è§£
- **å›¾åƒå¼•å¯¼**: CLIPè§†è§‰ç‰¹å¾èåˆ
- **å¸§ç‡è‡ªé€‚åº”**: FPSåµŒå…¥åŠ¨æ€è°ƒæ•´

## ğŸ”¬ æ ¸å¿ƒæ•°å­¦å…¬å¼

**Diffusion Forcingæ ¸å¿ƒå…¬å¼ï¼š**
```
x_{t-1} = Î±_t * x_t + Ïƒ_t * Îµ_Î¸(x_t, t, c)
```
å…¶ä¸­æ¯å¸§çš„tå¯ä»¥ä¸åŒï¼Œå®ç°å¼‚æ­¥å»å™ª

**é•¿è§†é¢‘ç”Ÿæˆé€’æ¨ï¼š**
```  
V_n = DF(prompt, V_{n-1}[-overlap:], frames=base_length)
V_final = Concat(V_1, V_2[overlap:], ..., V_n[overlap:])
```

è¿™ç§è®¾è®¡ä½¿SkyReels-V2æˆä¸ºé¦–ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„**æ— é™é•¿åº¦è§†é¢‘ç”Ÿæˆæ¨¡å‹**ï¼ŒåŒæ—¶åœ¨è´¨é‡ã€ä¸€è‡´æ€§å’Œæ•ˆç‡æ–¹é¢éƒ½è¾¾åˆ°äº†SOTAæ°´å¹³ã€‚å…¶æ ¸å¿ƒåˆ›æ–°åœ¨äºå°†ä¼ ç»Ÿçš„åŒæ­¥æ‰©æ•£è½¬å˜ä¸º**å¼‚æ­¥æ¡ä»¶æ‰©æ•£**ï¼Œç»“åˆä¸“ä¸šçš„**ç”µå½±è¯­æ³•ç†è§£**å’Œ**å¤šé˜¶æ®µä¼˜åŒ–ç­–ç•¥**ï¼Œå®ç°äº†ä»çŸ­è§†é¢‘åˆ°é•¿è§†é¢‘ã€ä»æ¦‚å¿µç†è§£åˆ°è§†è§‰å‘ˆç°çš„å…¨é“¾è·¯çªç ´ã€‚

## ğŸ“š å¤šé˜¶æ®µè®­ç»ƒç­–ç•¥

**å®Œæ•´è®­ç»ƒæµæ°´çº¿ï¼š**

```
é˜¶æ®µ1: åŸºç¡€é¢„è®­ç»ƒ
â”œâ”€â”€ æ•°æ®: ~2Mé«˜è´¨é‡å¹³è¡¡è§†é¢‘
â”œâ”€â”€ æ¨¡å‹: Transformer + VAEè”åˆè®­ç»ƒ  
â”œâ”€â”€ ç›®æ ‡: åŸºç¡€è§†é¢‘ç†è§£èƒ½åŠ›
â””â”€â”€ æ—¶é•¿: 24fpsè§†é¢‘æ•°æ®ï¼Œ97å¸§è¾“å…¥

é˜¶æ®µ2: å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–
â”œâ”€â”€ ç›®æ ‡: è¿åŠ¨è´¨é‡æå‡
â”œâ”€â”€ æ–¹æ³•: Direct Preference Optimization (DPO)
â”œâ”€â”€ æ•°æ®: è¿åŠ¨è´¨é‡é…å¯¹æ ·æœ¬
â””â”€â”€ é‡ç‚¹: å¤§å˜å½¢è¿åŠ¨ã€ç‰©ç†ä¸€è‡´æ€§

é˜¶æ®µ3: Diffusion Forcingè®­ç»ƒ  
â”œâ”€â”€ ç›®æ ‡: æ— é™é•¿åº¦ç”Ÿæˆèƒ½åŠ›
â”œâ”€â”€ æ–¹æ³•: å˜é•¿å™ªå£°çº§åˆ«è®­ç»ƒ
â”œâ”€â”€ æ¶æ„: AutoRegressive Diffusion Forcing
â””â”€â”€ ç‰¹ç‚¹: æ¯å¸§ç‹¬ç«‹æ—¶é—´æ­¥è°ƒåº¦

é˜¶æ®µ4: é«˜è´¨é‡SFT 
â”œâ”€â”€ 540P SFT: æ¦‚å¿µå¹³è¡¡è®­ç»ƒ
â”œâ”€â”€ 720P SFT: é«˜åˆ†è¾¨ç‡å¾®è°ƒ
â”œâ”€â”€ æ•°æ®: æ‰‹å·¥ç­›é€‰é«˜è´¨é‡æ ·æœ¬  
â””â”€â”€ ç›®æ ‡: è§†è§‰è´¨é‡æœ€ç»ˆæå‡
```

---

*åˆ›å»ºæ—¶é—´ï¼š2025å¹´1æœˆ*  
*é¡¹ç›®ï¼šSkyReels-V2*  
*çŠ¶æ€ï¼šæŠ€æœ¯è§£æå®Œæˆ*
